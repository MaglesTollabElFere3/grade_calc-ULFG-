<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Grade calc</title>
<style>
:root{--blue:#1e3a5f;--blue2:#2f5fa3;--bg:#0b1220;--text:#fff}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
header{background:var(--blue);padding:20px;position:relative;text-align:center}
header img{position:absolute;left:20px;top:10px;width:90px}
header h1{margin:0;font-size:26px}
#ayah{margin-top:10px;font-size:22px}
.switch{position:absolute;right:20px;top:20px;font-size:14px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #2a3d5c;padding:10px;text-align:center}
th{background:#223a5e}
input{width:80px;padding:5px;text-align:center}
button{padding:6px 12px;background:var(--blue2);color:#fff;border:none;border-radius:6px;cursor:pointer}
.avg{font-weight:bold;font-size:18px}
.fail{color:#c0392b;font-weight:600}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;color:#000;padding:20px;border-radius:10px;text-align:center}
@media(max-width:600px){input{width:60px}header img{width:70px}}
</style>
</head>
<body>
<header>
<img src="logo.png" alt="logo">
<h1>Grade calc</h1>
<div id="ayah">وَقُلْ رَبِّ زِدْنِي عِلْمًا</div>
<label class="switch"><input type="checkbox" checked onchange="toggleAyah(this)"> إظهار الآية</label>
</header>

<table id="tbl">
<thead>
<tr>
<th>المادة</th><th>Credits</th><th>Partial</th><th>Final</th><th>Raise</th><th>Average</th><th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
<br>
<button onclick="addRow()">إضافة مادة</button>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3>معدل الدفعة</h3>
    <input id="cp" type="number" placeholder="Partial"><br>
    <input id="cf" type="number" placeholder="Final"><br><br>
    <button onclick="confirmRaise()">OK</button>
  </div>
</div>

<script>
let activeRow=null;

function toggleAyah(cb){
  document.getElementById('ayah').style.display = cb.checked ? 'block' : 'none';
}

function addRow(){
  const tr=document.createElement('tr');
  tr.dataset.raise='0';
  tr.dataset.submitted='false';
  tr.innerHTML=`
    <td data-type="text"><input></td>
    <td data-type="num"><input type="number"></td>
    <td data-type="num"><input type="number"></td>
    <td data-type="num"><input type="number"></td>
    <td><span>0</span></td>
    <td class="avg">0</td>
    <td>
      <button onclick="toggleSubmit(this)">Submit</button>
      <button onclick="openRaise(this)">Raise</button>
    </td>`;
  document.querySelector('#tbl tbody').appendChild(tr);
}

function toggleSubmit(btn){
  const tr=btn.closest('tr');
  const avgCell=tr.querySelector('.avg');

  if(tr.dataset.submitted==='false'){
    const tds=tr.querySelectorAll('td[data-type]');
    const values=[];

    tds.forEach(td=>{
      const v=td.querySelector('input').value;
      values.push(v);
      td.innerHTML=`<span>${v}</span>`;
    });

    const p=Number(values[2]);
    const f=Number(values[3]);
    const hi=Math.max(p,f);
    const lo=Math.min(p,f);
    const base=hi*0.6 + lo*0.4;

    tr.dataset.base=base;

    const finalAvg=base + Number(tr.dataset.raise);
    avgCell.textContent=finalAvg.toFixed(2);
    avgCell.classList.toggle('fail', finalAvg < 60);

    btn.textContent='Edit';
    tr.dataset.submitted='true';

  } else {
    const tds=tr.querySelectorAll('td[data-type]');
    tds.forEach(td=>{
      const val=td.textContent;
      td.innerHTML=`<input value="${val}">`;
    });

    btn.textContent='Submit';
    tr.dataset.submitted='false';
  }
}

function openRaise(btn){
  activeRow=btn.closest('tr');
  document.getElementById('modal').style.display='flex';
}

function confirmRaise(){
  const cp=Number(document.getElementById('cp').value);
  const cf=Number(document.getElementById('cf').value);

  const hi=Math.max(cp,cf);
  const lo=Math.min(cp,cf);
  const classAvg=hi*0.6 + lo*0.4;

  let raise=0;
  if(classAvg < 66) raise = 66 - classAvg;

  activeRow.dataset.raise = raise;
  activeRow.querySelector('td:nth-child(5) span').textContent = raise.toFixed(2);

  if(activeRow.dataset.submitted==='true'){
    const base=Number(activeRow.dataset.base);
    const avgCell=activeRow.querySelector('.avg');
    const finalAvg=base + raise;
    avgCell.textContent=finalAvg.toFixed(2);
    avgCell.classList.toggle('fail', finalAvg < 60);
  }

  document.getElementById('modal').style.display='none';
}
</script>
</body>
</html>
